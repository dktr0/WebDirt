!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.WebDirt=t():e.WebDirt=t()}(self,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function s(e,t){if(this.msg=e,this.ac=t.ac,this.sampleBank=t.sampleBank,this.outputNode=t.destination,this.cutGroups=t.cutGroups,this.eventCounter=t.eventCounter,this.audioOutputs=t.audioOutputs,this.workletsAvailable=t.workletsAvailable,"object"==typeof e.buffer)this.bufferContainer=e.buffer;else{if(null==this.sampleBank)return void console.log("WebDirt: there is no sample bank, cancelling event");if("object"!=typeof this.sampleBank)return void console.log("WebDirt: buffer not provided by calling application + no WebDirt sample bank");if(this.msg.n=parseInt(this.msg.n),isNaN(this.msg.n)&&(this.msg.n=0),!this.sampleBank.sampleNameExists(this.msg.s))return void console.log("WebDirt: no sample named "+this.msg.s+" exists in sample map");if(!this.sampleBank.getBufferMightSucceed(this.msg.s,this.msg.n))return}if(this.when=this.msg.when,isNaN(this.when))console.log("WebDirt: 'when' is null or not a number");else if(this.nudge=parseFloat(this.msg.nudge),isNaN(this.nudge)||(this.when=this.when+this.nudge),isNaN(parseFloat(this.msg.speed))&&(this.msg.speed=1),0!=this.msg.speed)if(isNaN(parseFloat(this.msg.note))&&(this.msg.note=0),this.msg.speed=this.msg.speed*Math.pow(2,this.msg.note/12),this.msg.begin=n(this.msg.begin,0),this.msg.end=n(this.msg.end,1),this.msg.end!=this.msg.begin){if(this.msg.begin>this.msg.end&&(this.msg.speed=-1*this.msg.speed),this.msg.speed<0&&(this.msg.begin=1-this.msg.begin,this.msg.end=1-this.msg.end),this.msg.begin>this.msg.end){let e=this.msg.begin;this.msg.begin=this.msg.end,this.msg.end=e}var s;if(this.source=s=this.ac.createBufferSource(),this.source.onended=this.disconnectHandler(),this.disconnectOnEnd(this.source),this.source.playbackRate.value=Math.abs(this.msg.speed),this.prepareBuffer(),null!=this.buffer)this.source.buffer=this.buffer,this.start();else{var i=this,a=1e3*(this.msg.when-this.ac.currentTime-.2);a<=0&&(a=1e3*(this.msg.when-this.ac.currentTime-.2)),a>0&&setTimeout((function(){i.prepareBuffer(),null!=i.buffer?(i.source.buffer=i.buffer,i.start()):(console.log("WebDirt: unable to access sample "+e.s+":"+e.n+" on second attempt"),i.stopAll())}),a)}this.cut(this.msg.cut,this.msg.s),s=this.shape(s,this.msg.shape),s=this.lowPassFilter(s,this.msg.cutoff,this.msg.resonance),s=this.highPassFilter(s,this.msg.hcutoff,this.msg.hresonance),s=this.bandPassFilter(s,this.msg.bandf,this.msg.bandq),s=this.vowel(s,this.msg.vowel),s=this.delay(s,this.msg.delay,this.msg.delaytime,this.msg.delayfeedback),s=this.loop(s,this.msg.loop,this.msg.begin,this.msg.end,this.msg.speed),s=this.crush(s,this.msg.crush),s=this.coarse(s,this.msg.coarse),this.unit(this.msg.unit,this.msg.speed);var o=parseFloat(this.msg.gain);isNaN(o)&&(o=1),o>2&&(o=2),o<0&&(o=0);var r=parseFloat(this.msg.overgain);isNaN(r)||(o+=r),o=Math.pow(o,4);var l,c,u,h=parseFloat(e.pan);if(isNaN(h)&&(h=.5),2==this.audioOutputs)(h>1||h<0)&&(h-=Math.floor(h)),l=h,c=0,u=1;else{var p=(h-=Math.floor(h))*this.audioOutputs;(u=(c=Math.floor(p))+1)>=this.audioOutputs&&(u=0),l=p-Math.floor(p)}var f=this.ac.createGain();this.disconnectOnEnd(f);var d=this.ac.createGain();this.disconnectOnEnd(d),f.gain.value=Math.cos(l*Math.PI/2)*o,d.gain.value=Math.sin(l*Math.PI/2)*o,s.connect(f),s.connect(d),this.gain1=f,this.gain2=d;var m=this.ac.createChannelMerger(this.audioOutputs);this.disconnectOnEnd(m),f.connect(m,0,c),d.connect(m,0,u),m.connect(this.outputNode)}else this.stopAll()}function n(e,t){let s=parseFloat(e);return isNaN(s)?t:s>1?1:s<0?0:s}e.r(t),e.d(t,{WebDirt:()=>o}),s.prototype.prepareBuffer=function(){"object"==typeof this.bufferContainer?"object"==typeof this.bufferContainer.buffer&&(this.msg.speed>=0?this.buffer=this.bufferContainer.buffer:("object"==typeof this.bufferContainer.reverseBuffer||(this.bufferContainer.reverseBuffer=reverseBuffer(this.ac,this.bufferContainer.buffer)),this.buffer=this.bufferContainer.reverseBuffer)):(this.msg.speed>=0?this.buffer=this.sampleBank.getBuffer(this.msg.s,this.msg.n):this.buffer=this.sampleBank.getReverseBuffer(this.msg.s,this.msg.n),this.buffer=this.accel(this.buffer,this.msg.accelerate,this.msg.speed))},s.prototype.disconnectOnEnd=function(e){null==this.source.disconnectQueue&&(this.source.disconnectQueue=new Array),this.source.disconnectQueue.unshift(e)},s.prototype.start=function(){let e=Math.abs(this.msg.speed),t=(this.msg.end-this.msg.begin)*this.source.buffer.duration/e,s=this.msg.begin*this.source.buffer.duration;this.source.start(this.when,s,t)},s.prototype.stopAll=function(){if(null!=this.source&&null!=this.source.disconnectQueue){for(var e=0;e<this.source.disconnectQueue.length;e++)this.source.disconnectQueue[e].disconnect();this.source.disconnectQueue=null;try{this.source.stop()}catch(e){}}},s.prototype.disconnectHandler=function(){var e=this;return function(){setTimeout((function(){if(null==e.source.disconnectQueue)throw Error("WebDirt: no disconnectQueue for event "+e.eventCounter);for(var t=0;t<e.source.disconnectQueue.length;t++)e.source.disconnectQueue[t].disconnect();e.source.disconnectQueue=null}),250)}},s.prototype.coarse=function(e,t){if(t=parseInt(t),isNaN(t)&&(t=1),t>1&&this.workletsAvailable){var s=new AudioWorkletNode(this.ac,"coarse-processor");return s.parameters.get("coarse").value=t,e.connect(s),this.disconnectOnEnd(s),s}return e},s.prototype.crush=function(e,t){if(t=parseInt(t),isNaN(t)&&(t=null),null!=t&&t>0&&this.workletsAvailable){var s=new AudioWorkletNode(this.ac,"crush-processor");return s.parameters.get("crush").value=t,e.connect(s),this.disconnectOnEnd(s),s}return e},s.prototype.cut=function(e,t){if(e=parseInt(e),!isNaN(e)&&0!=e){for(var s={cutGroup:e,node:this,sampleName:t},n=0;n<this.cutGroups.length;n++){var i=this.cutGroups[n];i.cutGroup==e&&(e<0?i.sampleName==t&&(i.node.stop(this.when),this.cutGroups.splice(n,1)):(i.node.stop(this.when),this.cutGroups.splice(n,1)))}this.cutGroups.push(s)}},s.prototype.delay=function(e,t,s,n){if(isNaN(parseInt(t))&&(t=0),0!=(t=Math.abs(t))){var i=this.ac.createDelay();this.disconnectOnEnd(i),isNaN(parseInt(s))&&(console.log("WebDirt: warning: delaytime not a number, using default of 1"),s=1),i.delayTime.value=s;var a=this.ac.createGain();this.disconnectOnEnd(a),isNaN(parseInt(n))&&(console.log("WebDirt: warning: delayfeedback not a number, using default of 0.5"),n=.5),a.gain.value=Math.min(Math.abs(n),.995);var o=this.ac.createGain();return this.disconnectOnEnd(o),o.gain.value=t,e.connect(i),i.connect(a),i.connect(o),o.gain.setValueAtTime(o.gain.value,this.when+parseFloat(s)),a.connect(i),o}return e},s.prototype.highPassFilter=function(e,t,s){if(isNaN(parseFloat(t))&&isNaN(parseFloat(s)))return e;isNaN(parseFloat(t))&&(t=440),t<20&&(t=20),t>2e4&&(t=2e4),isNaN(parseFloat(s))&&(s=0),s<0&&(s=0),s>1&&(s=1),s=1/(s=1-.999*(s*=s));var n=this.ac.createBiquadFilter();return this.disconnectOnEnd(n),n.type="highpass",n.frequency.value=t,n.Q.value=s,e.connect(n),n},s.prototype.lowPassFilter=function(e,t,s){if(isNaN(parseFloat(t))&&isNaN(parseFloat(s)))return e;isNaN(parseFloat(t))&&(t=440),t<20&&(t=20),t>2e4&&(t=2e4),isNaN(parseFloat(s))&&(s=0),s<0&&(s=0),s>1&&(s=1),s=1/(s=1-.999*(s*=s));var n=this.ac.createBiquadFilter();return this.disconnectOnEnd(n),n.type="lowpass",n.frequency.value=t,n.Q.value=s,e.connect(n),n},s.prototype.bandPassFilter=function(e,t,s){if(isNaN(parseFloat(t))&&isNaN(parseFloat(s)))return e;isNaN(parseFloat(t))&&(t=440),t<20&&(t=20),t>2e4&&(t=2e4),isNaN(parseFloat(s))&&(s=10),s<1&&(s=1),s>100&&(s=100);var n=this.ac.createBiquadFilter();return this.disconnectOnEnd(n),n.type="bandpass",n.frequency.value=t,n.Q.value=s,n.gain.value=s,e.connect(n),n},s.prototype.loop=function(e,t){if(isNaN(parseInt(t))||0==t)return e;try{var s=this.source.buffer.duration-this.msg.begin*this.source.buffer.duration-(1-this.msg.end)*this.source.buffer.duration;return this.source.loop=!0,this.source.loopStart=this.msg.begin*this.source.buffer.duration,this.source.loopEnd=this.msg.end*this.source.buffer.duration,this.source.stop(this.when+s*t/this.source.playbackRate.value),e}catch(t){return console.log("WebDirt Warning: buffer data not yet available to calculate loop time - no looping applied"),e}},s.prototype.accelerate=function(e,t){if(t=Math.abs(t),isNaN(parseFloat(e))&&(e=0),0!=e){e=parseFloat(e),this.source.playbackRate.setValueAtTime(t,this.when);var s=Math.abs((this.source.buffer.length*e/this.ac.sampleRate+t)/t),n=t+this.source.buffer.length*e/this.ac.sampleRate;if(n<0)this.source.buffer=this.negativeAccelerateBuffer(this.source.buffer,e,t),this.source.playbackRate.linearRampToValueAtTime(0,this.when+s),this.source.playbackRate.linearRampToValueAtTime(1,this.when+this.source.buffer.duration);else try{this.source.playbackRate.linearRampToValueAtTime(n,this.when+this.source.buffer.duration)}catch(e){console.log("WebDirt: Warning, buffer data not loaded, could not apply acclerate effect")}}},s.prototype.negativeAccelerateBuffer=function(e,t,s){var n=e.length,i=new Float32Array(n),a=this.ac.createBuffer(e.numberOfChannels,e.length,this.ac.sampleRate),o=new Float32Array(n),r=Math.abs(s/(s-t))*n;r=n*Math.abs((this.source.buffer.length*t/this.ac.sampleRate+s)/s)/this.source.buffer.duration,r=Math.trunc(r);for(var l=0;l<e.numberOfChannels;l++){e.copyFromChannel(i,l,0);for(var c=0;c<r;c++)o[c]=i[c];for(c=0;c<n-r;c++)o[c+r]=i[r-c];a.copyToChannel(o,l,0)}return a},s.prototype.accel=function(e,t,s){if(isNaN(parseFloat(t)))return e;t=parseFloat(t);try{var n=e.length}catch(e){return void console.log("WebDirt: Warning, buffer data not loaded, accelerate effect not applied")}for(var i=new Float32Array(n),a=this.ac.createBuffer(e.numberOfChannels,e.length,this.ac.sampleRate),o=new Float32Array(n),r=0;r<e.numberOfChannels;r++){var l=s;e.copyFromChannel(i,r,0);for(var c=0,u=0;u<n&&(o[c]=i[Math.round(u)],l+=t/this.ac.sampleRate,!(u<0));u+=l)c++;a.copyToChannel(o,r,0)}return a},s.prototype.shape=function(e,t){if(t=parseFloat(t),isNaN(t)&&(t=0),t>=1&&(t=.999),t>0&&this.workletsAvailable){var s=new AudioWorkletNode(this.ac,"shape-processor");return s.parameters.get("shape").value=t,e.connect(s),this.disconnectOnEnd(s),s}return e},s.prototype.stop=function(e){this.gain1.gain.setValueAtTime(this.gain1.gain.value,e),this.gain1.gain.linearRampToValueAtTime(0,e+.02),this.gain2.gain.setValueAtTime(this.gain1.gain.value,e),this.gain2.gain.linearRampToValueAtTime(0,e+.02)},s.prototype.unit=function(e,t){"c"==e&&(this.source.playbackRate.value=this.source.playbackRate.value*this.source.buffer.duration)},s.prototype.vowel=function(e,t){if("string"!=typeof t)return e;if("a"==(t=t.toLowerCase())||"e"==t||"i"==t||"o"==t||"u"==t){var s,n,a,o=this.ac.createGain();switch(this.disconnectOnEnd(o),t){case"a":s=i.a.freqs,n=i.a.qs,a=i.a.amps;break;case"e":s=i.e.freqs,n=i.e.qs,a=i.e.amps;break;case"i":s=i.i.freqs,n=i.i.qs,a=i.i.amps;break;case"o":s=i.o.freqs,n=i.o.qs,a=i.o.amps;break;case"u":s=i.u.freqs,n=i.u.qs,a=i.u.amps}for(var r=0;r<5;r++){var l=this.ac.createGain();this.disconnectOnEnd(l),l.gain.value=a[r];var c=this.ac.createBiquadFilter();this.disconnectOnEnd(c),c.type="bandpass",c.Q.value=n[r]/8,c.frequency.value=s[r],e.connect(c),c.connect(l),l.connect(o)}return o.gain.value=8,o}return e};var i={a:{freqs:[660,1120,2750,3e3,3350],amps:[1,.5012,.0708,.0631,.0126],qs:[80,90,120,130,140]},e:{freqs:[440,1800,2700,3e3,3300],amps:[1,.1995,.1259,.1,.1],qs:[70,80,100,120,120]},i:{freqs:[270,1850,2900,3350,3590],amps:[1,.0631,.0631,.0158,.0158],qs:[40,90,100,120,120]},o:{freqs:[430,820,2700,3e3,3300],amps:[1,.3162,.0501,.0794,.01995],qs:[40,80,100,120,120]},u:{freqs:[370,630,2750,3e3,3400],amps:[1,.1,.0708,.0316,.01995],qs:[40,60,100,120,120]}};function a(e,t,s){this.STATUS_PRELOAD=0,this.STATUS_LOADING=1,this.STATUS_READY=2,this.STATUS_ERROR=3,this.sampleMapUrl=e,this.urlPrefix=t,this.samples={};var n=new XMLHttpRequest;n.open("GET",this.sampleMapUrl,!0),n.responseType="json";var i=this;n.onload=function(){if(4!=n.readyState)throw Error("WebDirt: readyState != 4 in callback of sampleMap load");if(200!=n.status)throw Error("WebDirt: status != 200 in callback of sampleMap load");if(null==n.response)throw Error("WebDirt: JSON response null in callback of sampleMap load");i.sampleMap=n.response,console.log("WebDirt: sampleMap loaded from "+i.sampleMapUrl),"function"==typeof s&&s()},n.onerror=function(){console.log("WebDirt: unspecified error in loading of sampleMap from "+i.sampleMapUrl)},n.send()}function o(e){this.workletsAvailable=!1,void 0===e&&(e={}),"object"==typeof e?("string"==typeof e.sampleMapUrl?(null==e.sampleFolder&&(e.sampleFolder="samples"),console.log("WebDirt: will manage own sample bank, samplemap="+e.sampleMapUrl+" sampleFolder="+e.sampleFolder),this.sampleBank=new a(e.sampleMapUrl,e.sampleFolder,e.readyCallback)):console.log("WebDirt: will expect application to provide sample buffers"),null==e.latency&&(e.latency=.4),this.latency=e.latency,"number"!=typeof e.maxLateness?this.maxLateness=.005:this.maxLateness=e.maxLateness,this.ac=e.audioContext,this.destination=e.destination,this.cutGroups=new Array,this.eventCounter=0,this.audioOutputs=2,null==this.ac?console.log("WebDirt: initialized (without audio context)"):null==this.destination?(this.destination=this.ac.destination,console.log("WebDirt: initialized with provided context")):console.log("WebDirt: initialized with provided context + destination")):console.log("WebDirt: unable to construct WebDirt object, arguments object not provided to constructor")}return a.prototype.loadAllNamed=function(e){if(null==this.ac)throw Error("WebDirt: called SampleBank.loadAllNamed with null audio context");if(null==this.sampleMap)throw Error("WebDirt: SampleBank.loadAllNamed: sampleMap is null");if(null!=this.sampleMap[e])for(var t=0;t<this.sampleMap[e].length;t++)this.load(this.getFilename(e,t));else console.log("WebDirt: can't loadAllNamed "+e+" (not present in sampleMap)")},a.prototype.load=function(e,t){if(null==this.samples[e]&&(this.samples[e]={},this.samples[e].status=this.STATUS_PRELOAD),this.samples[e].status!=this.STATUS_READY){if(this.samples[e].status!=this.STATUS_ERROR&&this.samples[e].status!=this.STATUS_LOADING){this.samples[e].status=this.STATUS_LOADING;var s=this.urlPrefix+"/"+e,n=new XMLHttpRequest;try{n.open("GET",s,!0),n.responseType="arraybuffer";var i=this;n.onload=function(){i.ac.decodeAudioData(n.response,(function(s){i.samples[e].buffer=s,i.samples[e].status=i.STATUS_READY,"function"==typeof t&&t()}),(function(t){console.log("WebDirt: error decoding "+s),i.samples[e].status=i.STATUS_ERROR}))},n.onerror=function(){console.log("WebDirt: error requesting "+s),i.samples[e].status=i.STATUS_ERROR},n.send()}catch(t){console.log("WebDirt: exception loading "+s+" = "+t),i.samples[e].status=i.STATUS_ERROR}}}else"function"==typeof t&&t()},a.prototype.sampleNameExists=function(e){return null==this.sampleMap?(console.log("WebDirt: can't lookup sample bank because sampleMap doesn't exist"),!1):null!=this.sampleMap[e]},a.prototype.getFilename=function(e,t){return null==t&&(t=0),t<0&&(t=this.sampleMap[e].length-Math.abs(t)%this.sampleMap[e].length),t%=this.sampleMap[e].length,this.sampleMap[e][t]},a.prototype.getBufferMightSucceed=function(e,t){var s=this.getFilename(e,t);if(null==this.samples[s])return!0;if(this.samples[s].status==this.STATUS_PRELOAD)return!1;if(this.samples[s].status==this.STATUS_LOADING)return!0;if(this.samples[s].status==this.STATUS_READY)return!0;if(this.samples[s].status==this.STATUS_ERROR)return!1;throw Error("WebDirt: SampleBank.getBufferMightSucceed: unrecognized status for "+e+":"+t)},a.prototype.getBuffer=function(e,t){var s=this.getFilename(e,t);return null==this.samples[s]?(this.load(s),null):this.samples[s].status==this.STATUS_PRELOAD?(console.log("WebDirt: *strange error* in SampleBank.getBuffer: sample "+e+":"+t+" status is PRELOAD"),null):this.samples[s].status==this.STATUS_ERROR?(console.log("WebDirt: SampleBank.getBuffer: sample "+e+" has status error"),null):this.samples[s].status==this.STATUS_LOADING?(console.log("WebDirt: SampleBank.getBuffer: "+e+":"+t+" is still loading"),null):this.samples[s].status==this.STATUS_READY?this.samples[s].buffer:(console.log("WebDirt: *strange error* in SampleBank.getBuffer: sample "+e+":"+t+" has unknown status"),null)},a.prototype.getReverseBuffer=function(e,t){if(null!=this.sampleMap[e]){var s=this.getFilename(e,t);if(null!=this.samples[s]){if(null!=this.samples[s].reverseBuffer)return this.samples[s].reverseBuffer;if(this.samples[s].status==this.STATUS_READY)return this.samples[s].reverseBuffer=function(e,t){for(var s=t.length,n=new Float32Array(s),i=e.createBuffer(t.numberOfChannels,t.length,e.sampleRate),a=new Float32Array(s),o=0;o<t.numberOfChannels;o++){t.copyFromChannel(n,o,0);for(var r=0;r<s;r++)a[r]=n[s-r];a[0]=a[1],i.copyToChannel(a,o,0)}return i}(this.ac,this.samples[s].buffer),this.samples[s].reverseBuffer}return this.load(s),null}console.log("WebDirt: can't getReverseBuffer "+e+" (not present in sampleMap)")},o.prototype.initializeWebAudio=function(){if(null==this.ac)try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.ac=new AudioContext,this.destination=this.ac.destination,console.log("WebDirt: own audio context created")}catch(e){return console.log(e),void alert("Web Audio API is not supported in this browser")}if(null!=this.ac){null!=this.ac.audioWorklet?this.ac.audioWorklet.addModule("WebDirt/AudioWorklets.js").then((()=>{console.log("WebDirt: audio worklets added"),this.workletsAvailable=!0})).catch((e=>{console.log("WebDirt: error loading AudioWorklets.js: "+e),console.log("(WebDirt should still work but shape, coarse, and crush will have no effect)"),this.workletsAvailable=!1})):(console.log("WebDirt: browser does not support audio worklets"),console.log("(WebDirt should still work but shape, coarse, and crush will have no effect)"),this.workletsAvailable=!1),this.tempo={time:this.ac.currentTime,beats:0,bpm:30},this.clockDiff=Date.now()/1e3-this.ac.currentTime,null!=this.sampleBank&&(this.sampleBank.ac=this.ac),this.silentNote=this.ac.createOscillator(),this.silentNote.type="sine",this.silentNote.frequency.value=440,this.silentGain=this.ac.createGain(),this.silentGain.gain.value=0,this.silentNote.connect(this.silentGain),this.silentGain.connect(this.ac.destination),this.silentNote.start();var e=this;setTimeout((function(){e.silentGain.disconnect(e.ac.destination),e.silentNote.disconnect(e.silentGain),e.silentNote.stop(),e.silentGain=null,e.silentNote=null}),500)}console.log("WebDirt: initializeWebAudio finished.")},o.prototype.playSample=function(e,t){if(null==t&&(t=this.latency),null!=e.whenPosix&&(e.when=e.whenPosix-((new Date).getTime()/1e3-this.ac.currentTime)),null==e.when&&(e.when=this.ac.currentTime),e.when=e.when+t,"number"!=typeof e.maxLateness&&(e.maxLateness=this.maxLateness),this.ac.currentTime-e.when>e.maxLateness)return void console.log("WebDirt warning: dropping msg late by "+(this.ac.currentTime-e.when)+" seconds");let n=new s(e,this);return this.eventCounter++,n},o.prototype.playScore=function(e,t,s){this.initializeWebAudio(),null==t&&(t=this.latency);for(var n=this.ac.currentTime,i=0,a=0;a<e.length;a++){var o=e[a];o.when>i&&(i=o.when),o.when=o.when+n,null!=o.s&&(o.sample_name=o.s),null!=o.n&&(o.sample_n=o.n),this.playSample(o,t)}setTimeout((function(){"function"==typeof s&&s()}),1e3*(i+t))},o.prototype.playScoreWhenReady=function(e,t,s,n){this.initializeWebAudio(),null==t&&(t=this.latency);for(var i=e.length,a=0;a<e.length;a++){var o=e[a],r=this;null!=o.s&&(o.sample_name=o.s),null!=o.n&&(o.sample_n=o.n),null!=this.sampleBank&&this.sampleBank.load(o.sample_name,o.sample_n,(function(){(i-=1)<=0&&(r.playScore(e,t,n),"function"==typeof s&&s())}))}},o.prototype.loadAndPlayScore=function(e,t,s,n){this.initializeWebAudio(),null==t&&(t=this.latency);var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="json";var a=this;i.onload=function(){if(4!=i.readyState)throw Error("readyState != 4 in callback of loadAndPlayScore");if(200!=i.status)throw Error("status != 200 in callback of loadAndPlayScore");if(null==i.response)throw Error("JSON response null in callback of loadAndPlayScore");console.log("playing JSON score from "+e),a.playScoreWhenReady(i.response,t,s,n)},i.send()},o.prototype.renderAndPlayScore=function(e,t,s,n,i,a,o){this.initializeWebAudio(),null==i&&(i=this.latency),window.WebSocket=window.WebSocket||window.MozWebSocket,console.log("WebDirt.renderAndPlayScore: attempting websocket connection to "+e);var r=new WebSocket(e);r.onerror=function(){console.log(" ERROR opening websocket connection to "+e)},r.onopen=function(){console.log(" websocket connection to "+e+" established");try{var i='{"render":'+JSON.stringify(t)+',"cps":'+s+',"cycles":'+n+"}";console.log(i),r.send(i),console.log(" render request sent")}catch(e){console.log(" EXCEPTION during transmission of render request"),r.close()}};var l=this;r.onmessage=function(t){var s=JSON.parse(t.data);if(!s instanceof Array)return console.log(" WebDirt warning: rendering socket received non-array message"),console.log(typeof s),void(globalX=s);console.log(" received score from "+e),l.playScoreWhenReady(s,i,a,o),console.log(" closing websocket connection to "+e),r.close()}},o.prototype.subscribeToTidalSocket=function(e,t){this.initializeWebAudio(),null==t&&(t=!1),window.WebSocket=window.WebSocket||window.MozWebSocket,console.log("WebDirt: attempting websocket connection to "+e),ws=new WebSocket(e),ws.onopen=function(){console.log("websocket connection to tidalSocket opened")},ws.onerror=function(){console.log("ERROR opening websocket connection to tidalSocket")};var s=this;ws.onmessage=function(e){if(null==e.data)throw Error("null data in tidalSocket onmessage handler");var n=JSON.parse(e.data);if(null==n.address)throw Error("received message from tidalSocket with no address: "+e.data);if("/play"!=n.address)throw Error("address of message from tidalSocket wasn't /play: "+e.data);if(n.args.constructor!==Array)throw Error("ERROR: message from tidalSocket where args doesn't exist or isn't an array: "+e.data);if(30!=n.args.length&&33!=n.args.length)throw Error("ERROR: message from tidalSocket with "+n.args.length+" args instead of 30 or 33: "+e.data);var i={};i.when=n.args[0]+n.args[1]/1e6+s.clockDiff,i.sample_name=n.args[3],i.begin=n.args[5],i.end=n.args[6],i.speed=n.args[7],i.pan=n.args[8],i.vowel=n.args[10],i.cutoff=n.args[11],i.resonance=n.args[12],i.accelerate=n.args[13],i.shape=n.args[14],i.gain=n.args[16],i.cut=n.args[17],i.delay=n.args[18],i.delaytime=n.args[19],i.delayfeedback=n.args[20],i.crush=n.args[21],i.coarse=n.args[22],i.hcutoff=n.args[23],i.hresonance=n.args[24],i.bandf=n.args[25],i.bandq=n.args[26],i.unit_name=n.args[27],i.sample_loop=n.args[28],i.sample_n=n.args[29],33==n.args.length&&(i.attack=n.args[30],i.hold=n.args[31],i.release=n.args[32]),s.playSample(i),t&&console.log(n)}},o.prototype.getCurrentTime=function(){return this.ac.currentTime},o.prototype.syncWithEsp=function(e){if("function"==typeof EspClient)if(null==this.espClient){this.espClient=new EspClient(e,this.ac);var t=this;this.espClient.tempoCallback=function(e){t.tempo=e}}else this.espClient.setUrl(e);else console.log("WebDirt ERROR: syncWithEsp called but EspClient does not exist")},o.prototype.setTempo=function(e){if("number"!=typeof e.time)throw Error("WebDirt: no time in setTempo");if("number"!=typeof e.beats)throw Error("WebDirt: no beats in setTempo");if("number"!=typeof e.bpm)throw Error("WebDirt: no bpm in setTempo");null!=this.espClient&&this.espClient.sendSetTempo(e),this.tempo=e},o.prototype.sampleHint=function(e){null!=this.sampleBank&&(console.log("WebDirt received sample hint: "+e),this.sampleBank.loadAllNamed(e))},t})()));